<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Survey Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container py-4">
        <div class="progress-container" id="progress-container">
            <div class="progress-circle bg-success text-white active" onclick="navigateTo('context')">C</div>
            <div class="progress-connector bg-secondary"></div>
            <div class="progress-circle bg-secondary text-white" onclick="navigateTo('section')" id="section-1">
                S1
                <div class="add-section" onclick="showAddModal(event, 'section-1')">
                    <i class="bi bi-plus"></i>
                </div>
            </div>
            <div class="progress-connector bg-secondary"></div>
            <div class="progress-circle bg-secondary text-white" onclick="navigateTo('review')">R</div>
        </div>

        <div class="modal fade" id="sectionModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="sectionType">
                                <option value="section">Section</option>
                                <option value="subsection">Subsection</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="sectionName">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addSection()">Add</button>
                    </div>
                </div>
            </div>
        </div>

        <iframe id="content-iframe" name="contentFrame"></iframe>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sectionModal = new bootstrap.Modal('#sectionModal');
        let currentParentId = '';
        let sectionCount = 1;
        let currentStage = 'context';

        // Load config from localStorage
        function loadConfig() {
            const savedConfig = localStorage.getItem('surveyConfig');
            window.surveyConfig = savedConfig ? JSON.parse(savedConfig) : {
                meta: {
                    currentStage: 'context',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                context: {},
                sections: {},
                review: {}
            };
            currentStage = window.surveyConfig.meta.currentStage;
        }

        // Save config to localStorage
        function saveConfig() {
            window.surveyConfig.meta.lastModified = new Date().toISOString();
            localStorage.setItem('surveyConfig', JSON.stringify(window.surveyConfig));
        }

        function updateProgress() {
            const circles = document.querySelectorAll('.progress-circle');
            const connectors = document.querySelectorAll('.progress-connector');
            
            circles.forEach(circle => circle.classList.remove('bg-success', 'active'));
            connectors.forEach(connector => connector.classList.remove('bg-success'));
            
            if(currentStage === 'context') {
                circles[0].classList.add('bg-success', 'active');
            } else if(currentStage === 'section') {
                circles[0].classList.add('bg-success');
                connectors[0].classList.add('bg-success');
                circles[1].classList.add('bg-success', 'active');
            } else if(currentStage === 'review') {
                circles.forEach(circle => circle.classList.add('bg-success'));
                connectors.forEach(connector => connector.classList.add('bg-success'));
                circles[circles.length - 1].classList.add('active');
            }
        }

        function showAddModal(e, parentId) {
            e.stopPropagation();
            currentParentId = parentId;
            sectionModal.show();
        }

        function addSection() {
            const type = document.getElementById('sectionType').value;
            const name = document.getElementById('sectionName').value;
            
            if(type === 'section') {
                sectionCount++;
                const newSection = document.createElement('div');
                newSection.className = 'progress-circle bg-secondary text-white';
                newSection.id = `section-${sectionCount}`;
                newSection.innerHTML = `S${sectionCount}`;
                newSection.onclick = function() { 
                    navigateTo('section');
                    document.querySelectorAll('.progress-circle').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                };
                
                const addButton = document.createElement('div');
                addButton.className = 'add-section';
                addButton.innerHTML = '<i class="bi bi-plus"></i>';
                addButton.onclick = function(e) { showAddModal(e, newSection.id); };
                newSection.appendChild(addButton);
                
                const connector = document.createElement('div');
                connector.className = 'progress-connector bg-secondary';
                
                const container = document.getElementById('progress-container');
                const reviewCircle = container.lastElementChild;
                container.insertBefore(connector, reviewCircle);
                container.insertBefore(newSection, reviewCircle);
                container.insertBefore(connector, reviewCircle);
            }
            
            sectionModal.hide();
            document.getElementById('sectionName').value = '';
            saveConfig();
        }

        function navigateTo(page) {
            currentStage = page;
            window.surveyConfig.meta.currentStage = page;
            saveConfig();
            updateProgress();
            const iframe = document.getElementById('content-iframe');
            iframe.src = `${page}.html`;
            iframe.onload = () => {
                const savedConfig = localStorage.getItem('surveyConfig');
                const config = JSON.parse(savedConfig);
                iframe.contentWindow.postMessage({
                    action: 'loadContextData',
                    data: config || {}
                }, '*');
                
            };
        }

        // Handle messages from iframe
        window.addEventListener('message', (event) => {
            if (event.data.action === 'saveState') {
                window.surveyConfig[event.data.page] = event.data.data; // Only keep latest data
                saveConfig();
            } else if (event.data.action === 'navigate') {
                navigateTo(event.data.page);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            navigateTo(currentStage);
            updateProgress();
        });

        // In index.html, update the message listener:
        window.addEventListener('message', (event) => {
            if (event.data.action === 'saveState') {
                if (event.data.data['section-1']?.apiKey) {
                    window.surveyConfig.apiKey = event.data.data['section-1'].apiKey; // Store at root
                }
                window.surveyConfig[event.data.page] = event.data.data;
                saveConfig();
            } else if (event.data.action === 'navigate') {
                navigateTo(event.data.page);
            }
        });
    </script>
</body>
</html>
